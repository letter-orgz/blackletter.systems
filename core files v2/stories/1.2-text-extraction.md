id: 1.2
epic: 1
title: Text Extraction (PDF/DOCX)
status: aligned
story: |
  As a system, I need to extract text, create a page map, and build a sentence index from uploaded PDF/DOCX files so that the detection engine can analyze the content.
acceptance_criteria:
  - Extract text → page map (page→char range) + sentence index
  - Store extraction artefacts linked to analysis record
  - Malformed/corrupt docs handled with explicit error codes
  - OCR default off; config flag enables OCR path
notes:
  - Use PyMuPDF for PDF, docx2python for DOCX as per tech stack.
  - Sentence splitting using blingfire.
  - Handle errors gracefully during extraction and persist error state.
tasks: []
dev_agent_record:
  proposed_tasks:
    - service: Implement extraction using PyMuPDF and docx2python
    - service: Build sentence index with blingfire
    - storage: Persist text, page map, and sentence index linked to analysis
    - config: Add OCR flag in configuration and handle OCR path
    - tests: Error handling for malformed documents
  file_list:
    - apps/api/blackletter_api/services/extraction.py
    - apps/api/blackletter_api/services/storage.py
    - apps/api/blackletter_api/services/tasks.py
    - apps/api/blackletter_api/tests/unit/test_extraction_docx.py
    - apps/api/blackletter_api/tests/integration/test_extraction_pipeline.py
  completion_notes: |
    Implemented PDF and DOCX extraction using PyMuPDF and docx2python. Built sentence index via blingfire and produced a page_map per page (DOCX as single page). Added OCR flag via environment variable OCR_ENABLED (default off) with optional pytesseract path; if OCR is requested without dependencies, a structured error is raised. Persisted extraction.json artifact with text_path, page_map, sentences, meta, checksum, and persisted error payload on failures. Updated job orchestration to record analysis status transitions and persist error reason to analysis.json. Added unit test for DOCX happy path and integration test for malformed DOCX persisting error.
  debug_log: |
    - Verified integration test for PDF extraction JSON shape.
    - Added malformed DOCX integration test validating persisted error and status.
    - Confirmed no new linter issues.
qa_results:
  summary: |
    All acceptance criteria validated via unit and integration tests.
    - Text extracted with page_map and sentence index (PDF & DOCX)
    - Extraction artifacts persisted and referenced by analysis
    - Malformed/corrupt documents persist structured error and set job status
    - OCR off by default; env flag toggles OCR path
  test_run:
    - cmd: pytest apps/api/blackletter_api/tests/unit/test_extraction_pdf.py -q
      result: passed (warnings only)
    - cmd: pytest apps/api/blackletter_api/tests/unit/test_extraction_docx.py -q
      result: passed (warnings only)
    - cmd: pytest apps/api/blackletter_api/tests/integration/test_extraction_pipeline.py -q
      result: passed (warnings only)
  evidence:
    - file: apps/api/blackletter_api/services/extraction.py
      note: Implements PDF/DOCX extraction, sentence index, OCR toggle, error handling
    - file: apps/api/blackletter_api/services/tasks.py
      note: Persists analysis status and handles extraction error path
  reviewer: qa
  date: 2025-08-29
