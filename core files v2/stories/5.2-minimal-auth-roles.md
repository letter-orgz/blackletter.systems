id: 5.2
epic: 5
title: Minimal Auth & Roles
status: Done
story: |
  As a system, I need to enforce role-based access control to ensure that only authorized users can perform specific actions like uploading files, changing settings, or exporting reports.
acceptance_criteria:
  - Admin can manage settings; Reviewer can upload/export only
  - Sessions persisted; CSRF protected
notes:
  - Define the permissions for Admin and Reviewer roles.
  - Integration with the frontend UI to show/hide features.
  - Backend middleware to check permissions on API endpoints.
  - Session management and CSRF protection are crucial for web security.
  - For MVP, this might be a simple implementation, potentially using basic auth or a library.
tasks: []
dev_agent_record:
  merge_note:
    - Consolidates duplicate auth UI story (was 1.2-user-authentication-setup.md) into this story
  proposed_tasks:
    - backend: Session-cookie auth with role claims; CSRF protection
    - backend: Guard /api/admin/* and settings/report mutations by role
    - frontend: Login/logout UI; route protection; role-based nav
    - tests: Auth happy/negative; role enforcement; CSRF
  open_decisions:
    - Supabase Auth vs. session-cookie per architecture (recommend session-cookie per arch)
    - Passwordless/email magic link vs. basic email+password for MVP

### dev_spec

- Middleware: Starlette `SessionMiddleware` for session cookie; custom `CSRFMiddleware` with `GET /api/auth/csrf` and `X-CSRF-Token` check on unsafe methods.
- Models/Services: simple JSON-backed user store with `{id,email,password_hash,role}`; bcrypt hashing; role checks.
- APIs: `POST /api/auth/login`, `/logout`, `GET /api/auth/me`; guard `/api/admin/*` and settings/report mutations.
- Web: `/login` page; role-based nav/route protection; hide admin sections from reviewers.

### qa_tests

- Login/logout/session persistence; CSRF required on mutations; forbidden for non-admins on admin endpoints.
- UI: route protection and visibility by role; secure cookies in prod.
  change_log:
    - 2025-08-29: Status updated to Done by BMad Orchestrator.
