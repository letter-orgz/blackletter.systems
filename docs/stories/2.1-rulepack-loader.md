id: 2.1
epic: 2
title: Rulepack Loader (art28_v1)
status: completed
story: |
  As a system, I need to load and validate the GDPR Article 28 rulepack so that the detection engine can use these rules to analyze contracts.
acceptance_criteria:
  - Load YAML; validate schema; list detectors and lexicons
  - On invalid YAML, surface clear errors
  - Config: rules path env var; hot‑reload disabled in prod
notes:
  - Rulepack file is `art28_v1.yaml`.
  - Lexicons are stored in `lexicons/` subdirectory.
  - Validation should check for required fields in rules/lexicons.
  - Loading should happen at application startup or via a specific admin action.
tasks: |
  - [x] **Backend Implementation**
    - [x] Create `services/rulepack_loader.py` with schema validation
    - [x] Implement YAML loading and validation
    - [x] Add lexicon loading from `lexicons/` subdirectory
    - [x] Implement caching with hot-reload control
    - [x] Add environment variable configuration (RULES_DIR, RULEPACK_FILE, APP_ENV)
  - [x] **Testing**
    - [x] Unit tests for happy path loading
    - [x] Unit tests for invalid YAML handling
    - [x] Unit tests for missing required fields
    - [x] Unit tests for unknown lexicon references
dev_agent_record:
  agent_model: "Claude Sonnet 4"
  debug_log_references: "Story 2.1 implementation completed"
  completion_notes: |
    ✅ **COMPLETED**: Rulepack loader fully implemented with:
    - YAML schema validation and error handling
    - Lexicon loading from subdirectories
    - Environment-based configuration
    - Hot-reload control (disabled in production)
    - Comprehensive unit test coverage
    - Integration with detector runner
  file_list: |
    - apps/api/blackletter_api/services/rulepack_loader.py (185 lines)
    - apps/api/blackletter_api/rules/art28_v1.yaml (11 lines)
    - apps/api/blackletter_api/rules/lexicons/weak_language.yaml (12 lines)
    - apps/api/blackletter_api/tests/unit/test_rulepack_loader.py (115 lines)
  qa_results: |
    ✅ **PASSED**: All acceptance criteria met
    - YAML loading and validation working
    - Clear error messages for invalid files
    - Environment configuration functional
    - Hot-reload properly controlled
    - Lexicon loading from subdirectories working
