id: 2.3
epic: 2
title: Weak‑Language Lexicon v0
status: done
story: |
  As a detection system, I need to apply a lexicon of weak language terms to findings to potentially downgrade a 'Pass' verdict to 'Weak' if no strong counter-anchors are found.
acceptance_criteria:
  - Apply lexicon inside evidence window
  - Downgrade Pass→Weak unless counter‑anchor present
  - Configurable lexicon file
notes:
  - Depends on the Detector Runner (Story 2.2) producing initial verdicts.
  - Lexicon file format needs to be defined (likely YAML).
  - Counter-anchor logic needs definition.
  - This is a post-processing step for findings.
tasks: []
dev_agent_record:
  proposed_tasks:
    - backend: Load lexicon file and expose matcher API
    - backend: Post-process findings to downgrade to Weak unless counter-anchors present
    - config: Feature toggle WEAK_LEXICON_ENABLED; bundle lexicon via rulepack loader
    - tests: Lexicon matches; downgrade behavior; counter-anchor overrides; whole-word boundaries
  dependencies:
    - story: 2.2-detector-runner
  open_decisions:
    - Phrase normalization: lowercase only in v0; no stemming (kept)
    - Window boundary handling via evidence window (Story 1.3) (kept)
    - Source of counter-anchors: Option 1 — rulepack-provided list (chosen)

  file_list:
    - apps/api/blackletter_api/services/weak_lexicon.py
    - apps/api/blackletter_api/services/detector_runner.py
    - apps/api/blackletter_api/rules/lexicons/weak_language.yaml
    - apps/api/blackletter_api/tests/unit/test_detector_mapping.py
    - apps/api/blackletter_api/tests/unit/test_detector_runner.py
    - apps/api/blackletter_api/services/token_ledger.py

  completion_notes: |
    - Implemented Option 1 precedence: rulepack-sourced lexicon and counter-anchors in `rules/lexicons/weak_language.yaml` take effect via `rulepack_loader` and are used by `postprocess_weak_language`.
    - Matching is whole-word and case-insensitive; counter-anchors short-circuit downgrade when present in the evidence window.
    - Added default counter-anchors to the rulepack (`must`, `shall`, `required`).
    - Env toggle `WEAK_LEXICON_ENABLED` remains supported (default '1').

  debug_log_references: |
    - Tests: `pytest apps/api/blackletter_api/tests -q` → all tests passed.
    - Verified weak-language downgrade on sentences with `may/might/could`; confirmed whole-word boundaries ("mayhem" doesn't match).
    - Verified rulepack counter-anchors `must/shall/required` prevent downgrade by default; explicit anchors still supported.

  qa_notes: |
    - Precedence: Rulepack > code defaults. No code defaults remain for weak terms; test suite sources terms from rulepack.
    - Matching: Regex with `\b` boundaries ensures whole words; `.lower()` normalization applied.
    - Counter-anchors: When not passed in, `postprocess_weak_language` uses rulepack-provided list; passing a list overrides.
    - Negative case verified: counter-anchor word in window (e.g., "required") prevents downgrade.

  agent_model_used: GPT-5 Dev

### dev_spec

- Loader: lexicon file `rules/lexicons/weak_language.yaml` with `terms`.
- Processor: `services/weak_lexicon.py apply_downgrade(findings, windows, counter_anchors)` lowers Pass→Weak when weak terms match and no counter-anchors present.
- Config: `WEAK_LEXICON_ENABLED=true` default; normalization via lowercase; optional stemming.

### qa_tests

- Matches cause downgrade; counter-anchors prevent it.
- Normalization ensures case-insensitive matching; respects window boundaries.
- Toggle-off path leaves findings unchanged.