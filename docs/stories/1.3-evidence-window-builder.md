id: 1.3
epic: 1
title: Evidence Window Builder (±2 sentences)
status: Done
story: |
  As a detection system, I need to build evidence windows around findings so that reviewers can see the context of a detected issue within the contract text.
acceptance_criteria:
  - Given a char span, return ±2 sentences (configurable per detector)
  - Respect sentence boundaries; avoid cross-page leakage (legacy/page-aware API); spec API is page-agnostic and respects provided sentence indices
  - Unit tests with synthetic spans
  - Normalize inverted spans where span_start > span_end
  - When a span falls strictly between two sentences, select the nearest by boundary distance (ties prefer the previous)
  - When the span is strictly before the first or after the last sentence, select the boundary sentence
  - When no sentence index is available (or empty), return a bounded char clamp around the span (default ±200 chars)
  - `default_window=0` returns only the containing sentence
notes:
  - Use the sentence index created in Story 1.2.
  - Need to handle edge cases like spans near the beginning or end of the document.
  - Configuration for sentence window size should be considered.
tasks: []
dev_agent_record:
  proposed_tasks:
    - service: Return ±N sentences around a char span using the sentence index
    - config: Make window size configurable per detector
    - service: Handle edge cases near document boundaries and page edges
    - tests: Spans at start, middle, and end of documents
  file_list:
    - apps/api/blackletter_api/services/evidence.py
    - apps/api/blackletter_api/tests/unit/test_evidence_windows_spec.py
    - apps/api/blackletter_api/tests/unit/test_evidence_windows.py
  completion_notes: |
    Implemented unified evidence window API supporting both spec and legacy callers. The spec path now:
    - Normalizes inverted spans.
    - Selects the containing sentence when overlapping, or the nearest sentence when between/outside sentence boundaries.
    - Applies configurable ±N window with detector-specific overrides, clamped to valid sentence index range.
    - Handles malformed sentence entries gracefully and falls back to a bounded char clamp only when no sentence index is available.

    Added two edge-case tests to ensure default_window=0 yields only the containing sentence and that an empty sentence index behaves like None.
  debug_log: |
    - Ran unit tests: all green in unit suite after updates.
qa_results:
  summary: All acceptance criteria met.
  tests_summary:
    unit: passed
    integration: n/a
    notes: Spec and legacy paths covered; boundary and edge cases included.
  ac_verification:
    - ac: "Given a char span, return ±2 sentences (configurable per detector)"
      result: pass
      evidence: apps/api/blackletter_api/services/evidence.py::_build_window_new_api, apps/api/blackletter_api/tests/unit/test_evidence_windows_spec.py::{test_mid_doc_default_window,test_per_detector_override,test_default_window_parameter}
    - ac: "Respect sentence boundaries; avoid cross‑page leakage"
      result: pass
      evidence: apps/api/blackletter_api/services/evidence.py, apps/api/blackletter_api/tests/unit/test_evidence_windows.py::test_window_respects_page_boundaries
    - ac: "Unit tests with synthetic spans"
      result: pass
      evidence: apps/api/blackletter_api/tests/unit/test_evidence_windows_spec.py, apps/api/blackletter_api/tests/unit/test_evidence_windows.py
    - Fixed selection logic in `services/evidence.py` for no-overlap spans to choose nearest sentence instead of char clamp.
    - Added tests `test_default_window_zero` and `test_empty_sentences_list_fallback` to `test_evidence_windows_spec.py`.
