id: 1.3
epic: 1
title: Evidence Window Builder (±2 sentences)
status: completed
story: |
  **As a** detection system,
  **I want** to build evidence windows around findings,
  **so that** reviewers can see the context of a detected issue within the contract text.
acceptance_criteria:
  - Given a char span, return ±2 sentences (configurable per detector)
  - Respect sentence boundaries; avoid cross‑page leakage
  - Handle edge cases like spans near the beginning or end of the document
  - Unit tests with synthetic spans covering all edge cases
interfaces:
  - **Service**: `evidence.py: build_window(text, sentence_index, page_map, char_start, char_end, window_sentences=2) -> EvidenceWindow`
  - **Dependencies**: Story 1.2 (extraction) for sentence index and page map
data_contract:
  - `analysis_dir/<analysis_id>/sentences.json` contains:
    - `page_map`: list of `{page, start, end}` with global character offsets
    - `sentences`: list of `{page, start, end, text}` where start/end are offsets
      relative to their page
tasks: |
  - [x] **Service Implementation**
    - [x] Implement `build_window()` function with configurable sentence count
    - [x] Handle page boundary respect (no cross-page leakage)
    - [x] Support configurable before/after sentence counts
    - [x] Handle edge cases near document boundaries
  - [x] **Testing**
    - [x] Unit tests for spans at start, middle, and end of documents
    - [x] Tests for page boundary handling
    - [x] Tests for configurable window sizes
dev_agent_record:
  agent_model: "Claude Sonnet 4"
  debug_log_references: "Story 1.3 implementation completed"
  completion_notes: |
    ✅ **COMPLETED**: Evidence window builder fully implemented with:
    - Configurable sentence window building (±N sentences)
    - Page boundary respect (no cross-page leakage)
    - Edge case handling for document boundaries
    - Comprehensive unit test coverage
    - Integration with detector runner
  file_list: |
    - apps/api/blackletter_api/services/evidence.py (41 lines)
    - apps/api/blackletter_api/tests/unit/test_evidence_windows.py (82 lines)
  qa_results: |
    ✅ **PASSED**: All acceptance criteria met
    - Configurable sentence windows working
    - Page boundary respect functional
    - Edge case handling working
    - Unit tests passing
change_log:
  - date: '2025-08-29'
    version: '1.0'
    description: "Completed story by implementing unit tests for the existing service logic. All tests pass."
    author: "James (Developer)"

### dev_spec

- Window builder: `services/evidence.py build_window(text, sentence_index, page_map, char_start, char_end, window_sentences=2)`
  - Use sentence index from Story 1.2; respect page boundaries from page_map
  - Default ±2 sentences; configurable per detector/rulepack
  - Return window text + metadata (start/end positions, page numbers)

### qa_tests

- Window building: spans at document start, middle, end; cross-page boundaries respected
- Edge cases: single sentence docs, spans near boundaries, configurable window sizes
- Integration: works with extraction artifacts from Story 1.2

### artifacts

- Files: `services/evidence.py`, test fixtures under `apps/api/tests/fixtures/evidence/`
