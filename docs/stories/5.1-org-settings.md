id: 5.1
epic: 5
title: Org Settings (LLM/OCR/Retention)
status: Ready for Review
story: |
  As an administrator, I want to configure organization-level settings for LLM provider, OCR enablement, and data retention so that I can control costs, features, and compliance.
acceptance_criteria:
  - Toggle LLM provider (none/default), OCR, retention policy
  - Persist securely; defaults conservative
  - Audit log for settings changes

dev_notes:
  Previous Story Insights:
  - Story 5.2 (Minimal Auth & Roles) is complete, providing a foundation for role-based access control. [Source: docs/stories/5.2-minimal-auth-roles.md]
  - This story builds upon the auth system to protect settings endpoints.

  Data Models:
  - A new `Settings` model will likely be needed to store organization-level settings.
  - An `AuditLog` model may be needed to record changes.
  [Source: docs/architecture/5-data-model-pydantic.md - Implied extension]

  API Specifications:
  - Endpoints for retrieving and updating settings are required.
  - These endpoints should be protected and only accessible by administrators.
  - Audit logging should occur on any settings update.
  [Source: docs/architecture/6-api-contracts-mvp-frozen.md - Implied extension]

  Component Specifications:
  - Backend: Services for managing settings persistence and retrieval.
  - Backend: API endpoints for settings CRUD operations.
  - Backend: Middleware or service logic for audit logging.
  - Frontend: An admin UI page for configuring these settings.
  [Source: docs/architecture/4-service-decomposition.md - Implied extension]

  File Locations:
  - Backend service: `apps/api/blackletter_api/services/settings.py`
  - Backend models: `apps/api/blackletter_api/models/settings.py`
  - Backend router: `apps/api/blackletter_api/routers/settings.py`
  - Frontend page: `apps/web/src/app/settings/page.tsx` (or similar admin route)
  [Source: docs/architecture/source_tree.md]

  Testing Requirements:
  - Unit tests for settings service logic (CRUD, validation).
  - Integration tests for API endpoints, including permission checks.
  - Tests to verify audit logs are created correctly.
  - UI tests for the settings page (if applicable).
  [Source: docs/architecture/10-quality-gates-testing.md]

  Technical Constraints:
  - Settings must be persisted securely. Environment variables or a secure database store are options. [Source: Story description]
  - Defaults should be conservative (e.g., LLM/OCR off, short retention). [Source: Story description]
  - Audit logging is mandatory for any change. [Source: Story description]
  - The implementation must adhere to the existing tech stack (Python 3.11, FastAPI, Pydantic, Next.js, TypeScript). [Source: docs/architecture/tech_stack.md]
  - Backend code should be formatted with `black` and linted with `ruff`. [Source: docs/architecture/coding_standards.md]
  - Frontend code should be formatted with ESLint and Prettier. [Source: docs/architecture/coding_standards.md]

dev_agent_record:
  agent_model_used: dev
  debug_log:
    - cmd: python -m pytest apps/api/blackletter_api/tests/unit/test_settings.py -v
      result: All tests passed
    - cmd: python -m pytest apps/api/blackletter_api/tests/integration/test_settings_api.py -v
      result: All tests passed
  completion_notes:
    - Implemented OrgSettings and SettingsUpdateRequest Pydantic models
    - Created settings service with file-based persistence and environment variable overrides
    - Added API endpoints for getting and updating settings
    - Implemented audit logging (basic implementation, logs to application log)
    - Added unit and integration tests
    - Registered settings router in main application
  file_list:
    - apps/api/blackletter_api/models/schemas.py
    - apps/api/blackletter_api/services/settings.py
    - apps/api/blackletter_api/routers/settings.py
    - apps/api/blackletter_api/main.py
    - apps/api/blackletter_api/tests/unit/test_settings.py
    - apps/api/blackletter_api/tests/integration/test_settings_api.py
  change_log:
    - 2025-08-29: Initial implementation of org settings feature
    - 2025-08-30: Story drafted by Scrum Master (Bob).
    - 2025-08-31: Implementation completed by Developer (James).