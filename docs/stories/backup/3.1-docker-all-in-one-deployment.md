id: 3.1
epic: 3
title: Docker All-in-One Deployment (Render)
status: Draft
story: |
  As a developer, I want to deploy the Blackletter stack as a single Dockerized service on Render so that I can have a simple, reproducible deployment for demos and early production.
acceptance_criteria:
  - Deploys on Render as a single Web Service (Docker) and passes health check.
  - `GET /` serves the landing page (SSR) with assets loading.
  - `GET /api` returns `{ "status": "ok" }` from FastAPI.
  - No CORS warnings in browser console (same origin).
  - Logs show three healthy processes (Nginx, Next.js, Uvicorn) with graceful shutdown.
  - Build is reproducible from clean checkout (no local artifacts required).

dev_notes:
  Previous Story Insights:
  - No previous story.

  Data Models:
  - No specific data models are directly involved in this deployment story.

  API Specifications:
  - The deployment must ensure that the FastAPI backend is accessible at `/api/*` and the Next.js frontend handles all other routes. [Source: docs/architecture/6-api-contracts-mvp-frozen.md]

  Component Specifications:
  - Dockerfile: Multi-stage build for Node.js (Next.js) and Python (FastAPI).
  - Nginx Configuration: Reverse proxy to route requests to the correct service.
  - Start Script: Orchestrates the startup of Nginx, Next.js, and Uvicorn.
  [Source: docs/architecture/4-service-decomposition.md (deployment section implied)]

  File Locations:
  - `deploy/docker/Dockerfile`
  - `deploy/docker/nginx.conf.template`
  - `deploy/docker/start.sh`
  - `render.yaml` (root)
  [Source: docs/architecture/source_tree.md (deployment paths implied)]

  Testing Requirements:
  - Local build/run serves `/` and `/api` OK; no CORS warnings.
  - Logs show Nginx, Next.js, Uvicorn healthy; graceful shutdown works.
  - Clean checkout builds reproducibly.
  [Source: docs/architecture/10-quality-gates-testing.md (deployment testing implied)]

  Technical Constraints:
  - The deployment must use a single Docker image. [Source: Story description]
  - Nginx must listen on the `$PORT` environment variable provided by Render. [Source: Story description]
  - Next.js runs on port 3000, FastAPI on port 8000 internally. [Source: Story description]
  - The solution must handle graceful shutdown of all processes. [Source: Story description]
  - The build process should be self-contained within the Dockerfile. [Source: Story description]

tasks:
  - [ ] Add `deploy/docker/Dockerfile` matching the spec. (AC: 1, 6)
  - [ ] Add `deploy/docker/nginx.conf.template` matching the spec. (AC: 1, 3, 4)
  - [ ] Add `deploy/docker/start.sh` and make it executable. (AC: 1, 5, 6)
  - [ ] Fix API router import: remove or implement `routers/analyses.py`. (AC: 1)
  - [ ] Build and run locally; verify `/` and `/api`. (AC: 2, 3, 4, 6)
  - [ ] Add root `render.yaml` for one-click deploy. (AC: 1)
  - [ ] Create Render Web Service from repo, env: Docker, health check `/`. (AC: 1)
  - [ ] Confirm deployment green; capture logs and URLs. (AC: 1, 5)
  - [ ] Update `apps/web/README.md` with Docker/Render run notes. (AC: 1)

change_log:
  - 2025-08-30: Story drafted by Scrum Master (Bob).