id: 1.3
epic: 1
title: Evidence Window Builder (±2 sentences)
status: Draft
story: |
  As a detection system, I need to build evidence windows around findings so that reviewers can see the context of a detected issue within the contract text.
acceptance_criteria:
  - Given a char span, return ±2 sentences (configurable per detector)
  - Respect sentence boundaries; avoid cross-page leakage (legacy/page-aware API); spec API is page-agnostic and respects provided sentence indices
  - Unit tests with synthetic spans
  - Normalize inverted spans where span_start > span_end
  - When a span falls strictly between two sentences, select the nearest by boundary distance (ties prefer the previous)
  - When the span is strictly before the first or after the last sentence, select the boundary sentence
  - When no sentence index is available (or empty), return a bounded char clamp around the span (default ±200 chars)
  - `default_window=0` returns only the containing sentence

dev_notes:
  Previous Story Insights:
  - The sentence index is created in Story 1.2. This story builds upon that to create context windows for findings. [Source: docs/stories/1.2-text-extraction.md]

  Data Models:
  - The `Finding` Pydantic model will be used, which includes `start` and `end` character offsets. [Source: docs/architecture/5-data-model-pydantic.md]
  ```python
  class Finding(BaseModel):
      detector_id: str
      rule_id: str
      verdict: Literal["pass","weak","missing","needs_review"]
      snippet: str
      page: int
      start: int
      end: int
      rationale: str
      reviewed: bool = False
  ```

  API Specifications:
  - No new API endpoints are required for this story. This is a backend service function. [Source: docs/architecture/6-api-contracts-mvp-frozen.md]

  Component Specifications:
  - New service: `apps/api/blackletter_api/services/evidence.py` containing the window building logic.
  [Source: docs/architecture/4-service-decomposition.md]

  File Locations:
  - New logic should be implemented in `apps/api/blackletter_api/services/evidence.py`.
  - Unit tests should be in `apps/api/blackletter_api/tests/unit/test_evidence_window_builder.py`.
  [Source: docs/architecture/source_tree.md]

  Testing Requirements:
  - Unit tests are required for all acceptance criteria, including edge cases like spans at document boundaries, inverted spans, and empty sentence indices. [Source: docs/architecture/10-quality-gates-testing.md]
  - Tests should use synthetic spans to cover various scenarios. [Source: docs/architecture/10-quality-gates-testing.md]

  Technical Constraints:
  - The implementation must adhere to the existing tech stack (Python 3.11, FastAPI, Pydantic). [Source: docs/architecture/tech_stack.md]
  - Code should be formatted with `black` and linted with `ruff`. [Source: docs/architecture/coding_standards.md]
  - The function should be efficient and handle large documents gracefully.

tasks:
  - [ ] Backend: Implement the core logic in `apps/api/blackletter_api/services/evidence.py` to build evidence windows based on character spans and sentence indices. (AC: 1, 2, 4, 5, 6, 7, 8)
  - [ ] Backend: Ensure the logic correctly handles inverted spans. (AC: 4)
  - [ ] Backend: Implement logic to select the nearest sentence when a span falls between sentences. (AC: 5)
  - [ ] Backend: Handle cases where the span is before the first or after the last sentence. (AC: 6)
  - [ ] Backend: Implement fallback to a bounded character clamp when no sentence index is available. (AC: 7)
  - [ ] Backend: Ensure `default_window=0` returns only the containing sentence. (AC: 8)
  - [ ] Tests: Write comprehensive unit tests in `apps/api/blackletter_api/tests/unit/test_evidence_window_builder.py` covering all ACs and edge cases. (AC: 3)

change_log:
  - 2025-08-30: Story drafted by Scrum Master (Bob).