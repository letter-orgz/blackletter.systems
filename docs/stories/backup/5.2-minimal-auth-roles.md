id: 5.2
epic: 5
title: Minimal Auth & Roles
status: Draft
story: |
  As a system, I need to enforce role-based access control to ensure that only authorized users can perform specific actions like uploading files, changing settings, or exporting reports.
acceptance_criteria:
  - Admin can manage settings; Reviewer can upload/export only
  - Sessions persisted; CSRF protected

dev_notes:
  Previous Story Insights:
  - This is the first story in Epic 5, focusing on foundational auth.
  - Future stories (like 5.1 Org Settings) will build upon this auth system.

  Data Models:
  - A `User` model will be needed with fields for `id`, `email`, `password_hash`, and `role`.
  - Session data will need to be stored, likely in a secure cookie.
  [Source: docs/architecture/5-data-model-pydantic.md - Implied extension]

  API Specifications:
  - Endpoints for login, logout, and fetching the current user's information are required.
  - Endpoints for admin functions (like settings management) will need protection.
  - CSRF protection must be implemented for state-changing operations.
  [Source: docs/architecture/6-api-contracts-mvp-frozen.md - Implied extension]

  Component Specifications:
  - Backend: Middleware for session management and CSRF protection.
  - Backend: Services for user authentication and role checking.
  - Backend: API endpoints for auth flows.
  - Frontend: Login/logout UI pages.
  - Frontend: Route protection and role-based navigation.
  [Source: docs/architecture/4-service-decomposition.md - Implied extension]

  File Locations:
  - Backend middleware: `apps/api/blackletter_api/middleware/auth.py` (or similar)
  - Backend services: `apps/api/blackletter_api/services/auth.py`
  - Backend models: `apps/api/blackletter_api/models/user.py`
  - Backend router: `apps/api/blackletter_api/routers/auth.py`
  - Frontend pages: `apps/web/src/app/login/page.tsx`, `apps/web/src/app/logout/route.ts` (or similar)
  [Source: docs/architecture/source_tree.md]

  Testing Requirements:
  - Unit tests for auth service logic (login, logout, role checks).
  - Integration tests for auth API endpoints.
  - Tests for CSRF protection effectiveness.
  - Tests for route protection on the frontend.
  [Source: docs/architecture/10-quality-gates-testing.md]

  Technical Constraints:
  - Session-cookie based auth is preferred over token-based for this setup. [Source: Story 5.2 dev_agent_record notes]
  - CSRF protection is mandatory for state-changing requests. [Source: Story description]
  - Passwords must be hashed securely (e.g., bcrypt). [Source: Implied best practice]
  - Sessions must be persisted securely. [Source: Story description]
  - The implementation must adhere to the existing tech stack (Python 3.11, FastAPI, Pydantic, Next.js, TypeScript). [Source: docs/architecture/tech_stack.md]
  - Backend code should be formatted with `black` and linted with `ruff`. [Source: docs/architecture/coding_standards.md]
  - Frontend code should be formatted with ESLint and Prettier. [Source: docs/architecture/coding_standards.md]

tasks:
  - [ ] Backend: Session-cookie auth with role claims; CSRF protection (AC: 1, 2) - Implement Starlette `SessionMiddleware`. Create custom `CSRFMiddleware` to generate tokens (`GET /api/auth/csrf`) and validate them (`X-CSRF-Token` header on unsafe methods).
  - [ ] Backend: Guard /api/admin/* and settings/report mutations by role (AC: 1) - Implement role-checking logic and decorators/middleware to protect admin-only endpoints and mutating actions related to settings/reports.
  - [ ] Backend: User Model and Auth Service - Define the `User` Pydantic/ORM model. Implement the authentication service for login (including password hashing) and logout.
  - [ ] API: Endpoints for login, logout, and fetching current user (AC: 1) - Create FastAPI endpoints: `POST /api/auth/login`, `POST /api/auth/logout`, `GET /api/auth/me`.
  - [ ] Frontend: Login/logout UI; route protection; role-based nav (AC: 1) - Create `/login` page with form. Implement client-side route protection based on session/role. Hide admin sections from reviewers in the UI.
  - [ ] Tests: Auth happy/negative; role enforcement; CSRF (AC: 1, 2) - Write unit and integration tests for the auth service and API endpoints. Include tests for successful login/logout, failed login attempts, role enforcement on protected routes/endpoints, and CSRF protection (valid token required, invalid token rejected).

change_log:
  - 2025-08-30: Story drafted by Scrum Master (Bob).