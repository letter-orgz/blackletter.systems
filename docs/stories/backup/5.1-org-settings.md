id: 5.1
epic: 5
title: Org Settings (LLM/OCR/Retention)
status: Draft
story: |
  As an administrator, I want to configure organization-level settings for LLM provider, OCR enablement, and data retention so that I can control costs, features, and compliance.
acceptance_criteria:
  - Toggle LLM provider (none/default), OCR, retention policy
  - Persist securely; defaults conservative
  - Audit log for settings changes

dev_notes:
  Previous Story Insights:
  - Story 5.2 (Minimal Auth & Roles) is complete, providing a foundation for role-based access control. [Source: docs/stories/5.2-minimal-auth-roles.md]
  - This story builds upon the auth system to protect settings endpoints.

  Data Models:
  - A new `Settings` model will likely be needed to store organization-level settings.
  - An `AuditLog` model may be needed to record changes.
  [Source: docs/architecture/5-data-model-pydantic.md - Implied extension]

  API Specifications:
  - Endpoints for retrieving and updating settings are required.
  - These endpoints should be protected and only accessible by administrators.
  - Audit logging should occur on any settings update.
  [Source: docs/architecture/6-api-contracts-mvp-frozen.md - Implied extension]

  Component Specifications:
  - Backend: Services for managing settings persistence and retrieval.
  - Backend: API endpoints for settings CRUD operations.
  - Backend: Middleware or service logic for audit logging.
  - Frontend: An admin UI page for configuring these settings.
  [Source: docs/architecture/4-service-decomposition.md - Implied extension]

  File Locations:
  - Backend service: `apps/api/blackletter_api/services/settings.py`
  - Backend models: `apps/api/blackletter_api/models/settings.py`
  - Backend router: `apps/api/blackletter_api/routers/settings.py`
  - Frontend page: `apps/web/src/app/settings/page.tsx` (or similar admin route)
  [Source: docs/architecture/source_tree.md]

  Testing Requirements:
  - Unit tests for settings service logic (CRUD, validation).
  - Integration tests for API endpoints, including permission checks.
  - Tests to verify audit logs are created correctly.
  - UI tests for the settings page (if applicable).
  [Source: docs/architecture/10-quality-gates-testing.md]

  Technical Constraints:
  - Settings must be persisted securely. Environment variables or a secure database store are options. [Source: Story description]
  - Defaults should be conservative (e.g., LLM/OCR off, short retention). [Source: Story description]
  - Audit logging is mandatory for any change. [Source: Story description]
  - The implementation must adhere to the existing tech stack (Python 3.11, FastAPI, Pydantic, Next.js, TypeScript). [Source: docs/architecture/tech_stack.md]
  - Backend code should be formatted with `black` and linted with `ruff`. [Source: docs/architecture/coding_standards.md]
  - Frontend code should be formatted with ESLint and Prettier. [Source: docs/architecture/coding_standards.md]

tasks:
  - [ ] Backend: Model and persistence for LLM provider, OCR, and retention policy (AC: 1, 2) - Define Pydantic models and ORM entities for settings. Implement secure persistence logic (e.g., database table with encryption at rest if needed, or secure config file). Ensure conservative defaults are applied.
  - [ ] API: Endpoints and admin UI to update settings (AC: 1) - Create FastAPI endpoints (`GET /api/admin/settings`, `POST /api/admin/settings`) for retrieving and updating settings. Protect these endpoints with admin role checks.
  - [ ] Security: Enforce secure storage with conservative defaults (AC: 2) - Implement the chosen secure storage mechanism. Ensure defaults for LLM (none), OCR (disabled), and retention (short) are set if no prior settings exist.
  - [ ] Logging: Audit logging for settings changes (AC: 3) - Implement logic to log every settings change, capturing the user, timestamp, old values, and new values. This could be a database table or integrated with an existing logging system.
  - [ ] Tests: Settings CRUD and security constraints (AC: 1, 2, 3) - Write unit tests for the settings service. Write integration tests for the API endpoints, including tests for permission enforcement and audit logging.
  - [ ] Frontend: Admin UI Page (Optional, depends on scope) - Create a frontend page for administrators to view and modify these settings. This would involve React/TypeScript components and React Query hooks to interact with the new API endpoints.

change_log:
  - 2025-08-30: Story drafted by Scrum Master (Bob).