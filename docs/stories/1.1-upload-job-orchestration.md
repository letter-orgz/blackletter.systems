id: 1.1
epic: 1 - Ingestion & Extraction
title: Upload & Job Orchestration
status: draft
detectors:
  - A28_3_a_instructions
  - A28_3_b_confidentiality
  - A28_3_c_security
nfrs:
  - p95_latency_ms: 500
  - cost_per_doc_gbp: 0.10
acceptance_criteria:
  - POST /api/contracts accepts multipart file (PDF/DOCX â‰¤10MB) and returns { job_id, analysis_id, status: 'queued' }.
  - GET /api/jobs/{job_id} returns { job_id, status: 'queued|running|done|error', error? }.
  - On 'done', an Analysis row exists with filename, size_bytes, mime, created_at.
  - Server rejects oversize or unsupported files with explicit error { code, message }.
  - Enqueue latency < 500ms server time.
  - Structured logs include job span and analysis id.
subtasks:
  - Backend: router uploads.py validates MIME/size, saves temp file, creates analysis row, enqueues background task, returns ids.
  - Backend: services/tasks.py implements enqueue('analyze', {analysis_id}) -> job_id using FastAPI BackgroundTasks.
  - Backend: models/entities.py defines SQLAlchemy Analysis model.
  - Backend: logging correlates job and analysis ids.
  - Frontend: /new page drag-drop uploader posts file then polls job status, showing progress UI.
  - Frontend: error banners with messages and retry.
fixtures:
  positive:
    - name: ok_basic.pdf
      path: apps/api/tests/fixtures/ok_basic.pdf
    - name: ok_basic.docx
      path: apps/api/tests/fixtures/ok_basic.docx
    - name: small_contract.pdf
      path: apps/api/tests/fixtures/small_contract.pdf
  negative:
    - name: oversize.pdf (>10MB)
      path: apps/api/tests/fixtures/oversize.pdf
    - name: unsupported.txt
      path: apps/api/tests/fixtures/unsupported.txt
    - name: corrupt.pdf
      path: apps/api/tests/fixtures/corrupt.pdf
dependencies: []
