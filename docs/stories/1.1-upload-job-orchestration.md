id: 1.1
epic: 1
title: Upload & Job Orchestration
status: Approved
story: |
  **As a** user,
  **I want** to upload a contract file (PDF/DOCX),
  **so that** the system can process it and provide analysis.
acceptance_criteria:
  - POST /contracts accepts PDF/DOCX â‰¤10MB; returns job_id
  - GET /jobs/{id} returns status: queued|running|done|error (+ error reason)
  - On done, analysis record exists with filename, size, created_at
  - Latency budget: enqueue < 500ms server time
tasks_subtasks: |
  - [ ] **Backend API (AC: #1, #2, #4)**
    - [ ] Create `apps/api/blackletter_api/routers/uploads.py` with a `POST /api/contracts` endpoint.
    - [ ] Add logic to accept `PDF` and `DOCX` files, using FastAPI's `UploadFile`.
    - [ ] Create `apps/api/blackletter_api/routers/jobs.py` with a `GET /api/jobs/{id}` endpoint.
    - [ ] Implement the job status polling logic (`queued`, `running`, `done`, `error`).
  - [ ] **Orchestration Service (AC: #1, #3)**
    - [ ] Create `apps/api/blackletter_api/services/tasks.py`.
    - [ ] Implement an `enqueue_contract_processing` function using FastAPI's `BackgroundTasks`.
    - [ ] The task should handle saving the file and creating the initial analysis metadata.
  - [ ] **Storage Service (AC: #3)**
    - [ ] Create `apps/api/blackletter_api/services/storage.py`.
    - [ ] Implement a `save_upload` function that stores the file in `.data/analyses/{analysis_id}/` and creates `analysis.json`.
    - [ ] Ensure file size check (<=10MB) is performed here or in the router.
  - [ ] **Frontend UI (AC: #1, #2)**
    - [ ] Create a new page/component with a file dropzone for `PDF`/`DOCX` files.
    - [ ] On file upload, call the `POST /api/contracts` endpoint.
    - [ ] On receiving a `job_id`, start polling the `GET /api/jobs/{id}` endpoint.
    - [ ] Display a loading indicator (e.g., spinner with "Processing...") to the user while polling.
    - [ ] On "done" status, redirect the user to the analysis results page (route TBD).
    - [ ] On "error" status, display a clear error message to the user.
  - [ ] **Testing (AC: #1, #2, #3, #4)**
    - [ ] Add unit tests for the `uploads` and `jobs` routers.
    - [ ] Add integration tests for the end-to-end upload and poll flow.
    - [ ] Write tests for all specified error conditions from the Testing section in Dev Notes.
dev_notes: |
  **General Notes:**
  - Virus and file size checks must be performed on the server-side. A signed upload URL is a potential future optimization but not for MVP.
  - For the MVP, we will use FastAPI's built-in `BackgroundTasks`. Celery is planned for a future phase when more robust queueing is needed.
  - The 10MB file size limit will be enforced on the server. The client should perform a pre-check for better UX, but the server is the final authority.

  **Source Tree:**
  - All new API code should be located under `apps/api/blackletter_api/`.
  - Routers: `routers/`
  - Services: `services/`
  - Data Persistence: `.data/analyses/`

  **Technical Specification:**
  - API endpoints are prefixed with `/api`.
  - `POST /api/contracts`: Accepts `multipart/form-data` with a file. Returns `{job_id, analysis_id, status: 'queued'}`.
  - `GET /api/jobs/{id}`: Returns `{id, status, analysis_id?, error_reason?}`.
  - Services should be designed for dependency injection in FastAPI.
  - For development and testing, a config flag `JOB_SYNC=1` can be used to process jobs synchronously.

  **Testing:**
  - Tests should be placed under `apps/api/blackletter_api/tests/`.
  - Use `pytest` and FastAPI's `TestClient`.
  - **Unit Test Cases:**
    - Uploading an unsupported file type (e.g., .txt) should return a `415 Unsupported Media Type` error.
    - Uploading a file > 10MB should return a `413 Payload Too Large` error.
    - Calling the endpoint with no file should return a `422 Unprocessable Entity` error.
  - **Integration Test Cases:**
    - A successful upload should return a `201 Created` status and a job ID.
    - Polling the job status should eventually transition to `done`.
    - After the job is done, the `analysis.json` file must exist in the correct directory.
  - **Performance Test Cases:**
    - Add a best-effort assertion to check that the initial enqueue request (`POST /api/contracts`) returns in under 500ms.
change_log:
  - date: '2025-08-29'
    version: '1.1'
    description: "Revised story to comply with template standards and incorporate PO feedback. Added missing sections, granular tasks, and consolidated dev notes."
    author: "Bob (Scrum Master)"
dev_agent_record:
  agent_model: "grok-code-fast-1"
  debug_log_references: ""
  completion_notes: "Story 1.1 fully implemented with backend API, storage service, orchestration, frontend UI, and comprehensive tests. All acceptance criteria met."
  file_list: "apps/api/blackletter_api/routers/contracts.py, apps/api/blackletter_api/routers/jobs.py, apps/api/blackletter_api/services/storage.py, apps/api/blackletter_api/services/tasks.py, apps/web/src/app/new/page.tsx, apps/web/src/lib/api.ts, apps/api/blackletter_api/tests/integration/test_upload_validation.py, apps/api/blackletter_api/tests/integration/test_job_polling_status.py"
qa_results: |
  2025-09-02 JD - Flow validated via integration tests (test_contracts_api.py, test_upload_validation.py, test_job_polling_status.py) and relevant unit tests.
