id: 1.2
epic: 1 - Ingestion & Extraction
title: Text Extraction (PDF/DOCX)
status: draft
detectors:
  - A28_3_a_instructions
  - A28_3_b_confidentiality
  - A28_3_c_security
nfrs:
  - p95_end_to_end_sec: 60
acceptance_criteria:
  - For a valid PDF or DOCX, produce text, page_map (page→[start,end]), and sentence_index (array of [start,end]).
  - Persist artefacts under apps/api/.data/analyses/{analysis_id}/ and link via ExtractionArtifact.
  - Malformed or corrupt files yield error { code:'extract_failed', message } and set job status 'error'.
  - OCR path exists but stays disabled by default; when disabled, image-only PDFs fail cleanly with hint.
subtasks:
  - Backend: implement extraction.py to handle PDF via PyMuPDF and DOCX via docx2python.
  - Backend: build sentence index with blingfire; store JSON for page_map and sentence_index.
  - Backend: wire into background task flow: intake → extract → detection.
  - Frontend: poll job status and on 'done' route to /analyses/:id.
fixtures:
  positive:
    - name: ok_basic.pdf
      path: apps/api/tests/fixtures/ok_basic.pdf
    - name: ok_basic.docx
      path: apps/api/tests/fixtures/ok_basic.docx
    - name: multi_page.pdf
      path: apps/api/tests/fixtures/multi_page.pdf
  negative:
    - name: image_only.pdf
      path: apps/api/tests/fixtures/image_only.pdf
    - name: corrupt.pdf
      path: apps/api/tests/fixtures/corrupt.pdf
    - name: empty.docx
      path: apps/api/tests/fixtures/empty.docx
dependencies:
  - 1.1
