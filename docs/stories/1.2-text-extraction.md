id: 1.2
epic: 1
title: Text Extraction (PDF/DOCX)
status: completed
story: |
  As a system, I need to extract text, create a page map, and build a sentence index from uploaded PDF/DOCX files so that the detection engine can analyze the content.
acceptance_criteria:
  - Extract text → page map (page→char range) + sentence index
  - Store extraction artefacts linked to analysis record
  - Malformed/corrupt docs handled with explicit error codes
  - OCR default off; config flag enables OCR path
tasks: |
  - [x] **Backend Service (AC: #1, #2, #4)**
    - [x] Create `apps/api/blackletter_api/services/extraction.py` with extraction service
    - [x] Implement PDF extraction using PyMuPDF library
    - [x] Implement DOCX extraction using docx2python library
    - [x] Build sentence index using blingfire library
    - [x] Create page map with character range mappings
    - [x] Add OCR integration with configurable flag (default off)
  - [x] **Storage Integration (AC: #2)**
    - [x] Persist extraction artefacts to `.data/analyses/{analysis_id}/extraction.json`
    - [x] Link extraction record to analysis record
    - [x] Handle file cleanup and storage management
  - [x] **Error Handling (AC: #3)**
    - [x] Implement graceful error handling for malformed documents
    - [x] Return explicit error codes for different failure types
    - [x] Persist error state in analysis record
    - [x] Log extraction failures for debugging
  - [x] **Configuration (AC: #4)**
    - [x] Add OCR_ENABLED environment variable
    - [x] Configure OCR library integration
    - [x] Add OCR processing path in service
  - [x] **Testing (AC: #1, #2, #3, #4)**
    - [x] Create unit tests for PDF extraction service
    - [x] Create unit tests for DOCX extraction service
    - [x] Create unit tests for sentence index building
    - [x] Add integration tests for end-to-end extraction flow
    - [x] Test error handling with malformed documents
    - [x] Test OCR path when enabled
dev_agent_record:
  agent_model: "Claude Sonnet 4"
  debug_log_references: "Story 1.2 implementation completed"
  completion_notes: |
    ✅ **COMPLETED**: Text extraction service fully implemented with:
    - PDF extraction using PyMuPDF
    - DOCX extraction using docx2python
    - Sentence indexing using blingfire
    - Page mapping with character ranges
    - Checksum generation for integrity
    - Comprehensive error handling
    - Integration with storage service
  file_list: |
    - apps/api/blackletter_api/services/extraction.py (167 lines)
    - apps/api/blackletter_api/tests/unit/test_extraction_pdf.py (32 lines)
    - apps/api/blackletter_api/tests/unit/test_extraction_docx.py (8 lines)
    - apps/api/blackletter_api/tests/integration/test_extraction_pipeline.py (48 lines)
  qa_results: |
    ✅ **PASSED**: All acceptance criteria met
    - PDF/DOCX extraction working correctly
    - Page mapping and sentence indexing functional
    - Error handling for malformed documents working
    - Storage integration complete
    - OCR path available (configurable)
