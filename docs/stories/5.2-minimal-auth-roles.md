id: 5.2
epic: 5
title: Minimal Auth & Roles
status: ready
story: |
  As a system, I need to enforce role-based access control to ensure that only authorized users can perform specific actions like uploading files, changing settings, or exporting reports. This story establishes the foundation for authentication and authorization within the application, defining two primary roles: Admin and Reviewer.
acceptance_criteria:
  - A user can log in with an email and password.
  - Sessions are securely managed and persisted across browser restarts.
  - The system is protected against Cross-Site Request Forgery (CSRF) attacks.
  - There are two user roles: 'Admin' and 'Reviewer'.
  - **Admin users can:**
    - Access and modify organization settings.
    - Invite and manage users (future story).
    - Perform all actions available to Reviewers.
  - **Reviewer users can:**
    - Upload documents for analysis.
    - View analysis results and findings.
    - Export analysis reports.
  - **Reviewer users cannot:**
    - Access organization settings.
    - Access any administrative endpoints or UI sections.
  - Unauthenticated users are redirected to a login page when attempting to access protected routes.
notes:
  - This story focuses on creating the core authentication and role-checking mechanism. User management (inviting, deleting users) will be handled in a subsequent story.
  - The initial implementation will use a simple, secure, server-side session-based approach.
design_decisions:
  - **Authentication Strategy:** A stateful session-cookie approach will be used over a stateless one (like JWTs) or a third-party service (like Supabase Auth). This aligns with the project's architecture for a self-contained backend and simplifies initial setup.
  - **Authentication Method:** Basic email and password authentication will be implemented for the MVP. Passwordless/magic link options were considered but deferred to prioritize core functionality.
tasks:
  - id: 5.2.1
    title: "Backend: Implement Session & CSRF Protection"
    description: "Set up server-side session management using Starlette's SessionMiddleware. Implement CSRF protection middleware that generates a token and validates it on all state-changing requests."
  - id: 5.2.2
    title: "Backend: Create User Model and Auth Endpoints"
    description: "Define a simple user model with email, hashed password, and role. Create API endpoints for login (`/api/auth/login`), logout (`/api/auth/logout`), and retrieving the current user (`/api/auth/me`). Use bcrypt for password hashing."
  - id: 5.2.3
    title: "Backend: Implement Role-Based Access Control"
    description: "Create middleware or route dependencies to guard API endpoints. Restrict access to administrative endpoints (e.g., `/api/admin/*`) and specific mutations (settings, reports) based on the user's role stored in the session."
  - id: 5.2.4
    title: "Frontend: Develop Login Page and Auth Logic"
    description: "Create a dedicated `/login` page. Implement logic to call the login API, manage the authenticated state, and handle token/session refresh."
  - id: 5.2.5
    title: "Frontend: Implement Route Protection and Role-Based UI"
    description: "Protect application routes from unauthenticated access. Dynamically render navigation and UI elements based on the user's role (e.g., hide the 'Settings' link for Reviewers)."
  - id: 5.2.6
    title: "Testing: Write Auth and RBAC Tests"
    description: "Develop integration and unit tests for login/logout flows, session persistence, CSRF protection, and role-based access rules (both happy paths and negative cases)."
dev_agent_record:
  merge_note:
    - Consolidates duplicate auth UI story (was 1.2-user-authentication-setup.md) into this story
  proposed_tasks:
    - backend: Session-cookie auth with role claims; CSRF protection
    - backend: Guard /api/admin/* and settings/report mutations by role
    - frontend: Login/logout UI; route protection; role-based nav
    - tests: Auth happy/negative; role enforcement; CSRF
dev_spec:
  - Middleware: Starlette `SessionMiddleware` for session cookie; custom `CSRFMiddleware` with `GET /api/auth/csrf` and `X-CSRF-Token` check on unsafe methods.
  - Models/Services: simple JSON-backed user store with `{id,email,password_hash,role}`; bcrypt hashing; role checks.
  - APIs: `POST /api/auth/login`, `/logout`, `GET /api/auth/me`; guard `/api/admin/*` and settings/report mutations.
  - Web: `/login` page; role-based nav/route protection; hide admin sections from reviewers.
qa_tests:
  - Verify successful login/logout and that session persists after closing/reopening the browser.
  - Verify that state-changing requests (POST, PUT, DELETE) fail without a valid CSRF token.
  - As a Reviewer, verify that access to admin pages/API endpoints is denied.
  - As an Admin, verify that all administrative functions are accessible.
  - Verify that unauthenticated users are redirected to the login page.
  - Ensure cookies are configured with `HttpOnly` and `Secure` flags in a production environment.
